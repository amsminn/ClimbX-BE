<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>ğŸ§ª ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ - ClimbX</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      max-width: 500px;
      width: 90%;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .header h1 {
      color: #333;
      margin-bottom: 0.5rem;
      font-size: 1.8rem;
    }

    .header p {
      color: #666;
      font-size: 0.9rem;
    }

    .section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 12px;
      border: 1px solid #e9ecef;
    }

    .section h3 {
      color: #495057;
      margin-bottom: 1rem;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: #495057;
      font-weight: 500;
      font-size: 0.9rem;
    }

    input[type="text"] {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin: 0.25rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(45deg, #6c757d, #495057);
    }

    .btn-secondary:hover {
      box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
    }

    .btn-kakao {
      background: linear-gradient(45deg, #fee500, #ffcd00);
      color: #3c1e1e;
      font-weight: bold;
    }

    .btn-kakao:hover {
      box-shadow: 0 4px 12px rgba(254, 229, 0, 0.4);
    }

    .result-box {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      line-height: 1.4;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }

    .result-success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .result-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .result-info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    .status {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
      margin-left: 0.5rem;
    }

    .status-connected {
      background: #d4edda;
      color: #155724;
    }

    .status-disconnected {
      background: #f8d7da;
      color: #721c24;
    }

    .token-display {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 0.5rem;
      margin: 0.5rem 0;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      word-break: break-all;
    }

    .api-test-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .step-indicator {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    .step-number {
      background: #667eea;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ§ª ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</h1>
    <p>ClimbX ë°±ì—”ë“œ API ê°œë°œìš© í…ŒìŠ¤íŠ¸ ë„êµ¬</p>
  </div>

  <!-- 1ë‹¨ê³„: ì—°ê²° í…ŒìŠ¤íŠ¸ -->
  <div class="section">
    <div class="step-indicator">
      <div class="step-number">1</div>
      <h3>ë°±ì—”ë“œ ì„œë²„ ì—°ê²°</h3>
    </div>

    <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
      ë°±ì—”ë“œ ì„œë²„ì™€ì˜ ì—°ê²°ì„ í™•ì¸í•©ë‹ˆë‹¤.
    </p>

    <button class="btn btn-secondary" onclick="testConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
    <span class="status status-disconnected" id="configStatus">ë¯¸ì—°ê²°</span>
  </div>

  <!-- 2ë‹¨ê³„: ì¹´ì¹´ì˜¤ ì¸ì¦ -->
  <div class="section">
    <div class="step-indicator">
      <div class="step-number">2</div>
      <h3>ì¹´ì¹´ì˜¤ ì¸ì¦</h3>
    </div>

    <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
      ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì„ ì§„í–‰í•˜ì—¬ ì¸ê°€ ì½”ë“œë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤. (í™˜ê²½ë³€ìˆ˜ì— ì„¤ì •ëœ KAKAO_REST_API_KEY ì‚¬ìš©)
    </p>

    <button class="btn btn-kakao" onclick="startKakaoLogin()">
      ğŸ”‘ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹œì‘
    </button>
  </div>

  <!-- 3ë‹¨ê³„: ì¸ê°€ ì½”ë“œ ì²˜ë¦¬ -->
  <div class="section">
    <div class="step-indicator">
      <div class="step-number">3</div>
      <h3>ì¸ê°€ ì½”ë“œ ì²˜ë¦¬</h3>
    </div>

    <div class="form-group">
      <label for="authCode">Authorization Code</label>
      <input id="authCode" placeholder="ì¹´ì¹´ì˜¤ì—ì„œ ë°›ì€ ì¸ê°€ ì½”ë“œ" type="text">
    </div>

    <button class="btn btn-secondary" onclick="extractCodeFromUrl()">
      URLì—ì„œ ìë™ ì¶”ì¶œ
    </button>
    <button class="btn" onclick="exchangeToken()">
      í† í° êµí™˜ ìš”ì²­
    </button>
  </div>

  <!-- 4ë‹¨ê³„: API í…ŒìŠ¤íŠ¸ -->
  <div class="section">
    <div class="step-indicator">
      <div class="step-number">4</div>
      <h3>API í…ŒìŠ¤íŠ¸</h3>
    </div>

    <div id="tokenInfo" style="display: none;">
      <p><strong>ë°œê¸‰ëœ í† í°:</strong></p>
      <div class="token-display" id="tokenDisplay"></div>
    </div>

    <div class="api-test-buttons">
      <button class="btn" onclick="testUserInfo()">
        ğŸ‘¤ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
      </button>
      <button class="btn" onclick="testRefreshToken()">
        ğŸ”„ í† í° ê°±ì‹ 
      </button>
    </div>
  </div>

  <!-- ê²°ê³¼ í‘œì‹œ -->
  <div id="resultContainer">
    <div class="result-box" id="resultBox"></div>
  </div>
</div>

<script>
  // ì „ì—­ ë³€ìˆ˜
  let config = {
    serverUrl: window.location.origin
  };
  let tokens = {};

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
  window.onload = function () {
    loadSavedConfig();
    checkUrlForCode();
  };

  // ì„¤ì • ì €ì¥/ë³µì›
  function saveConfig() {
    config.serverUrl = document.getElementById('serverUrl').value.trim();

    if (!config.serverUrl) {
      showResult('âŒ ë°±ì—”ë“œ ì„œë²„ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
      return;
    }

    localStorage.setItem('kakaoTestConfig', JSON.stringify(config));
    updateConfigStatus(true);
    showResult('âœ… ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
  }

  function loadSavedConfig() {
    const savedConfig = localStorage.getItem('kakaoTestConfig');
    if (savedConfig) {
      config = JSON.parse(savedConfig);
      if (document.getElementById('serverUrl')) {
        document.getElementById('serverUrl').value = config.serverUrl;
      }
      updateConfigStatus(true);
    }
  }

  function updateConfigStatus(isConfigured) {
    const statusElement = document.getElementById('configStatus');
    if (isConfigured) {
      statusElement.textContent = 'ì„¤ì •ì™„ë£Œ';
      statusElement.className = 'status status-connected';
    } else {
      statusElement.textContent = 'ë¯¸ì„¤ì •';
      statusElement.className = 'status status-disconnected';
    }
  }

  // ë°±ì—”ë“œ ì—°ê²° í…ŒìŠ¤íŠ¸
  async function testConnection() {
    if (!config.serverUrl) {
      showResult('âŒ ë¨¼ì € ë°±ì—”ë“œ ì„œë²„ URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”', 'error');
      return;
    }

    try {
      showResult('ğŸ”„ ë°±ì—”ë“œ ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...', 'info');

      const response = await fetch(`${config.serverUrl}/api/auth/oauth2/kakao/authorize-url`);

      if (response.ok) {
        showResult('âœ… ë°±ì—”ë“œ ì„œë²„ ì—°ê²° ì„±ê³µ! ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¤€ë¹„ ì™„ë£Œ', 'success');
      } else {
        showResult(`âŒ ë°±ì—”ë“œ ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (${response.status})`, 'error');
      }
    } catch (error) {
      showResult(`âŒ ë°±ì—”ë“œ ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ${error.message}`, 'error');
    }
  }

  // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹œì‘
  async function startKakaoLogin() {
    if (!config.serverUrl) {
      showResult('âŒ ë¨¼ì € ë°±ì—”ë“œ ì„œë²„ URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”', 'error');
      return;
    }

    try {
      showResult('ğŸ”„ ì¹´ì¹´ì˜¤ ì¸ì¦ URLì„ ìƒì„±í•˜ëŠ” ì¤‘...', 'info');

      const response = await fetch(`${config.serverUrl}/api/auth/oauth2/kakao/authorize-url`);

      if (response.ok) {
        const result = await response.json();
        const kakaoAuthUrl = result.body?.data || result.data || result;

        if (typeof kakaoAuthUrl !== 'string') {
          showResult(`âŒ ì˜ëª»ëœ ì‘ë‹µ í˜•íƒœ: ${JSON.stringify(result, null, 2)}`, 'error');
          return;
        }

        showResult('ğŸ”„ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...', 'info');
        setTimeout(() => {
          window.location.href = kakaoAuthUrl;
        }, 1000);
      } else {
        const errorText = await response.text();
        showResult(`âŒ ì¹´ì¹´ì˜¤ ì¸ì¦ URL ìƒì„± ì‹¤íŒ¨ (${response.status})\n\n${errorText}`, 'error');
      }
    } catch (error) {
      showResult(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
    }
  }

  // URLì—ì„œ ì¸ê°€ ì½”ë“œ í™•ì¸
  function checkUrlForCode() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const error = urlParams.get('error');

    if (error) {
      showResult(`âŒ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error}`, 'error');
      return;
    }

    if (code) {
      document.getElementById('authCode').value = code;
      showResult(`âœ… ì¸ê°€ ì½”ë“œë¥¼ URLì—ì„œ ìë™ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤: ${code.substring(0, 20)}...`, 'success');

      // URL ì •ë¦¬ (ì½”ë“œ íŒŒë¼ë¯¸í„° ì œê±°)
      const cleanUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
    }
  }

  function extractCodeFromUrl() {
    checkUrlForCode();
  }

  // í† í° êµí™˜
  async function exchangeToken() {
    const authCode = document.getElementById('authCode').value.trim();
    if (!authCode) {
      showResult('âŒ ì¸ê°€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
      return;
    }

    if (!config.serverUrl) {
      showResult('âŒ ë°±ì—”ë“œ ì„œë²„ URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”', 'error');
      return;
    }

    try {
      showResult('ğŸ”„ í† í° êµí™˜ ìš”ì²­ ì¤‘...', 'info');

      const response = await fetch(
          `${config.serverUrl}/api/auth/oauth2/kakao/callback?code=${authCode}`, {
            method: 'POST',
          });

      if (response.ok) {
        const apiResponse = await response.json();
        if (apiResponse.data) {
          tokens = apiResponse.data;
          displayTokenInfo();
          showResult(
              `âœ… í† í° êµí™˜ ì„±ê³µ!\n\n- Token Type: ${tokens.tokenType}\n- Expires In: ${tokens.expiresIn}ì´ˆ\n- Access Token: ${tokens.accessToken.substring(
                  0, 50)}...\n- Refresh Token: ${tokens.refreshToken.substring(0, 50)}...`,
              'success');
        } else {
          showResult(`âŒ í† í° êµí™˜ ì‹¤íŒ¨: ì‘ë‹µ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.`, 'error');
        }
      } else {
        const errorText = await response.text();
        showResult(`âŒ í† í° êµí™˜ ì‹¤íŒ¨ (${response.status})\n\n${errorText}`, 'error');
      }
    } catch (error) {
      showResult(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
    }
  }

  // í† í° ì •ë³´ í‘œì‹œ
  function displayTokenInfo() {
    const tokenInfoDiv = document.getElementById('tokenInfo');
    const tokenDisplayDiv = document.getElementById('tokenDisplay');

    tokenDisplayDiv.innerHTML = `
      <strong>Access Token:</strong> ${tokens.accessToken.substring(0, 50)}...<br>
      <strong>Refresh Token:</strong> ${tokens.refreshToken.substring(0, 50)}...<br>
      <strong>Token Type:</strong> ${tokens.tokenType}<br>
      <strong>Expires In:</strong> ${tokens.expiresIn}ì´ˆ
    `;

    tokenInfoDiv.style.display = 'block';
  }

  // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ í…ŒìŠ¤íŠ¸
  async function testUserInfo() {
    if (!tokens.accessToken) {
      showResult('âŒ ë¨¼ì € í† í°ì„ ë°œê¸‰ë°›ì•„ì£¼ì„¸ìš”', 'error');
      return;
    }

    try {
      showResult('ğŸ”„ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì¤‘...', 'info');

      const response = await fetch(`${config.serverUrl}/api/auth/me`, {
        headers: {
          'Authorization': `Bearer ${tokens.accessToken}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const userInfo = await response.json();
        showResult(`âœ… ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì„±ê³µ!\n\n${JSON.stringify(userInfo, null, 2)}`, 'success');
      } else {
        const errorText = await response.text();
        showResult(`âŒ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ (${response.status})\n\n${errorText}`, 'error');
      }
    } catch (error) {
      showResult(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
    }
  }

  // í† í° ê°±ì‹  í…ŒìŠ¤íŠ¸
  async function testRefreshToken() {
    if (!tokens.refreshToken) {
      showResult('âŒ ë¨¼ì € í† í°ì„ ë°œê¸‰ë°›ì•„ì£¼ì„¸ìš”', 'error');
      return;
    }

    try {
      showResult('ğŸ”„ í† í° ê°±ì‹  ì¤‘...', 'info');

      const response = await fetch(`${config.serverUrl}/api/auth/oauth2/refresh`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          refreshToken: tokens.refreshToken
        })
      });

      if (response.ok) {
        const result = await response.json();
        tokens = result.data || result;
        displayTokenInfo();
        showResult(`âœ… í† í° ê°±ì‹  ì„±ê³µ!\n\n- New Access Token: ${tokens.accessToken.substring(0, 50)}...\n- New Refresh Token: ${tokens.refreshToken.substring(0, 50)}...`, 'success');
      } else {
        const errorText = await response.text();
        showResult(`âŒ í† í° ê°±ì‹  ì‹¤íŒ¨ (${response.status})\n\n${errorText}`, 'error');
      }
    } catch (error) {
      showResult(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
    }
  }

  // ê²°ê³¼ í‘œì‹œ
  function showResult(message, type) {
    const resultBox = document.getElementById('resultBox');

    // íƒ€ì…ë³„ í´ë˜ìŠ¤ ì„¤ì •
    resultBox.className = `result-box result-${type}`;
    resultBox.textContent = message;
    resultBox.style.display = 'block';

    // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
    resultBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
</script>
</body>
</html> 